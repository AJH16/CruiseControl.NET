<html>
    <head>
        <title>CruiseControl.NET : NAntBuilder</title>
	    <link rel="stylesheet" href="styles/site.css" type="text/css" />
    </head>

    <body>
	    <table class="pagecontent" border="0" cellpadding="0" cellspacing="0" width="100%" bgcolor="#ffffff">
		    <tr>
			    <td valign="top" class="pagebody">
				    <div class="pageheader">
					    <span class="pagetitle">
                            CruiseControl.NET : NAntBuilder
                                                    </span>
				    </div>
				    <div class="pagesubheading">
					    This page last changed on Apr 22, 2004 by <font color="#0050B2">orogers</font>.
				    </div>

				    <p class="paragraph"><h3 class="heading3"> NAntBuilder Configuration Examples</h3></p><div class="code"><pre>&lt;build type=&quot;nant&quot;&gt;&#10;  &lt;executable&gt;c&#58;&#92;fromcvs&#92;myrepo&#92;myproject&#92;tools&#92;nant&#92;nant.exe&lt;/executable&gt;&#10;  &lt;baseDirectory&gt;c&#58;&#92;fromcvs&#92;myrepo&#92;myproject&lt;/baseDirectory&gt;&#10;  &lt;buildArgs&gt;&#45;D&#58;cvs.executable=c&#58;&#92;putty&#92;cvswithplinkrsh.bat&lt;/buildArgs&gt;&#10;  &lt;buildFile&gt;cruise.build&lt;/buildFile&gt;&#10;  &lt;logger&gt;NAnt.Core.XmlLogger&lt;/logger&gt;&#10;  &lt;targetList&gt;&#10;    &lt;target&gt;run&lt;/target&gt;&#10;  &lt;/targetList&gt;&#10;  &lt;buildTimeout&gt;300000&lt;/buildTimeout&gt;&#10;&lt;/build&gt;</pre></div>
<ul class="star">
<li> type (mandatory) - set this as &quot;nant&quot; to specify that you want to use the NAntBuilder</li>
<li> executable (mandatory) - The location of the nant.exe you want to use (it can be absolute, or relative to folder ccnet.exe is in.) Often this is set to a version of NAnt that is checked into Source Control with your project.</li>
<li> baseDirectory (mandatory) - The directory you want NAnt to be started in (normally the root directory of your project if that&#039;s where you store your NAnt build files)</li>
<li> buildFile (mandatory) - The name of the build file to run, relative to the baseDirectory. This would normally be your &#039;bootstrap&#039; file, as discussed (TODO)</li>
<li> buildArgs (optional) - You can use the &#039;buildArgs&#039; tag to pass through any parameters to NAnt. This is useful if you want to define some NAnt properties, e.g. in the example we pass through the location of a CVS executable as a NAnt property called &#039;cvs.executable&#039;.</li>
<li> targetList (optional) - A set of targets to be called. If you don&#039;t specifiy at least one, NAnt will use the project&#039;s default target. CruiseControl.NET does not call NAnt once for each target, it just specifies all the targets when it calls NAnt the one time for the build, so semantically specifying more than one target is the same as manually running NAnt yourself with more than one target.</li>
<li> buildTimeout (optional) - This element may be set to indicate the maximum amount of time in milliseconds CruiseControl.NET should wait for the build to finish. If you leave this element out, or set it to 0, then CruiseControl.NET will wait indefinitely for NAnt to finish (so if NAnt &#039;hangs&#039;, so will CruiseControl.NET)</li>
<li> logger (optional) - By default this argument will instruct NAnt to log its output as Xml by using the NAnt.Core.XmlLogger.  If you are using a version of NAnt prior to 0.8.3, you may need to specify the logger as SourceForge.NAnt.XmlLogger.</li>
</ul>
<h3 class="heading3"> NAnt output in Xml</h3><p class="paragraph">CruiseControl.NET expects NAnt to generate its output as Xml so that the build results can be parsed and rendered appropriately.  To accomplish this, CruiseControl.NET will, by default, launch NAnt using the &quot;<b class="strong">-logger:NAnt.Core.XmlLogger</b>&quot; argument.  If you want to override this behaviour, specify the <b class="strong">logger</b> property in the NAntBuilder configuration in the <b class="strong">ccnet.config</b> file.  If this element is specified but is empty then NAnt will be started with the default logger (though this may cause some problems for CCNet).  It is also possible to instruct NAnt to log its output to an Xml file and then merge the file into the build using the <a href="MergeFileTask.html">MergeFileTask</a>.</p><img src="./icons/emoticons/warning.png" height="16" width="16" align="absmiddle" alt="" border="0"/> NOTE: the configuration of which NAnt logger to use was orginally specified in the <b class="strong">ccnet.exe.config</b> file.  This has now been deprecated, and the &quot;NAnt.Logger&quot; element in the &lt;appSettings&gt; section can now be removed.<p class="paragraph"><h3 class="heading3"> Source Control and NAnt</h3>
While CruiseControl.NET will detect modifications for you it will not check out changes. It is up to you to add targets to your nant script to do that for you.  So, first you need to create a &#039;bootstrap&#039; build file that is used to get the latest changes to your source tree whenever an update is comitted. A good place to put this build file is in the same directory as your project&#039;s normal buildfile. This bootstrap file should do 2 things:
<ul class="star">
<li> Get the latest code from source control</li>
<li> Call the appropriate target in the actual project build file</li>
</ul><br/>
The following is an example for a project under CVS control (it assumes that a propery called &#039;cvs.executable&#039; is passed in from CruiseControl.NET - you can do this in the build/buildArgs section of the ccnet.config file):</p><div class="code"><pre>&lt;project name=&quot;ccnetlaunch&quot; default=&quot;go&quot;&gt;&#10;  &lt;target name=&quot;go&quot; depends=&quot;update,build&quot;/&gt;&#10;  &lt;target name=&quot;update&quot;&gt;&#10;    &lt;ifnot propertyexists=&quot;cvs.executable&quot;&gt;&#10;        &lt;fail message=&quot;cvs.executable property not set, so can&#039;t update&quot; /&gt;&#10;    &lt;/ifnot&gt;&#10;    &lt;echo message=&quot;CVS Executable at &#91;$&#123;cvs.executable&#125;&#93;&quot; /&gt;&#10;    &lt;exec &#10;        basedir=&quot;.&quot; &#10;        program=&quot;$&#123;cvs.executable&#125;&quot; &#10;        commandline=&quot;&#45;q update &#45;P &#45;d&quot; &#10;    /&gt;&#10;  &lt;/target&gt;&#10;  &lt;target name=&quot;build&quot;&gt;&#10;    &lt;nant &#10;        buildfile=&quot;myproject.build&quot; &#10;        target=&quot;ContinuousIntegration&quot; &#10;        inheritall=&quot;true&quot;&#10;    /&gt;&#10;  &lt;/target&gt;&#10;&lt;/project&gt;</pre></div><p class="paragraph">NOTE: The bootstrap buildfile above only updates the buildserver&#039;s local copy of your project&#039;s source. Before you even run CruiseControl.NET for the first time you need to checkout your project to the location on your machine where CruiseControl.NET will build it.</p><h3 class="heading3"> NUnit and NAnt</h3>
CruiseControl.NET uses xsl to process the build log and produce html for display on the web page. Since xml is so easy to parse the nunit2 task in NAnt can produce xml output. The tasks must be configured to do that in order for test results to show up on the web page. Typically this is done by adding a formatter element to the nunit2 task and setting the type to be &quot;Xml&quot;. Additionally the usefile flag of the formatter element must be set to &quot;false&quot;. If it isn&#039;t the nunit2 task will try and save the output to a file and not write it out to the build log.

<div class="code"><pre>&lt;target name=&quot;test.unit&quot; depends=&quot;compile&quot; description=&quot;runs unit tests&quot;&gt;&#10;	&lt;nunit2&gt;&#10;		&lt;formatter type=&quot;Xml&quot; usefile=&quot;false&quot;/&gt;&#10;		&lt;test assemblyname=&quot;$&#123;build.dir&#125;&#92;$&#123;core.dll&#125;&quot; fork=&quot;true&quot;/&gt;&#10;		&lt;test assemblyname=&quot;$&#123;build.dir&#125;&#92;$&#123;console.exe&#125;&quot; fork=&quot;true&quot;/&gt;&#10;	&lt;/nunit2&gt;&#10;&lt;/target&gt;</pre></div> <p class="paragraph">It would be pretty tedious for developers to read the xml output when they run the build locally. Define a property for the build output type and set it to &quot;Plain&quot; and use the property in the formatter element..</p><div class="code"><pre>&lt;property name=&quot;outputType&quot; value=&quot;Plain&quot;/&gt;&#10;	...&#10;	&lt;formatter type=&quot;$&#123;outputType&#125;&quot; usefile=&quot;false&quot;/&gt;&#10;	...</pre></div>
	
Then in the build section of the ccnet.config file pass in a different value for outputType.

<div class="code"><pre>&lt;build type=&quot;nant&quot;&gt;&#10;	...&#10;	&lt;buildArgs&gt;&quot;&#45;DoutputType=Xml&quot;&lt;/buildArgs&gt;&#10;	...&#10;&lt;/build&gt;</pre></div><p class="paragraph"><h3 class="heading3"> Accessing CruiseControl.NET build labels in NAnt</h3></p>CCNet will pass the current build label to NAnt via the NAnt property &quot;label-to-apply&quot;.  This means that you can access use this property to, for example, archive the newly built assemblies in a folder with the same name as the build label (this is what we do on <span class="nobr"><a href="http://ccnetlive.thoughtworks.com/CCNet-builds/">CCNetLive<sup><img src="./icons/linkext7.gif" height="7" width="7" align="absmiddle" alt="&gt;&gt;" border="0"/></sup></a></span>.  Here&#039;s some example NAnt script demonstrating how to do this:

<div class="code"><pre>&lt;target name=&quot;dist.publish&quot; depends=&quot;dist&quot;&gt;&#10;	&lt;ifnot propertyexists=&quot;label&#45;to&#45;apply&quot;&gt;&#10;		&lt;fail message=&quot;label&#45;to&#45;apply property not set, so can&#039;t create labelled distribution files&quot; /&gt;&#10;	&lt;/ifnot&gt;	&#10;	&lt;property name=&quot;publish.dir&quot; value=&quot;D&#58;&#92;download&#45;area&#92;CCNet&#45;Builds&#92;$&#123;label&#45;to&#45;apply&#125;&quot; /&gt;&#10;&#10;	&lt;mkdir dir=&quot;$&#123;publish.dir&#125;&quot; /&gt;&#10;	&lt;copy todir=&quot;$&#123;publish.dir&#125;&quot;&gt;&#10;		&lt;fileset basedir=&quot;dist&quot;&gt;&#10;			&lt;includes name=&quot;&#42;&quot;/&gt;&#10;		&lt;/fileset&gt;&#10;	&lt;/copy&gt;			&#10;&lt;/target&gt;</pre></div>


				    
                    			    </td>
		    </tr>
	    </table>
	    <table border="0" cellpadding="0" cellspacing="0" width="100%">
			<tr>
				<td height="12" background="border/border_bottom.gif"><img src="border/spacer.gif" width="1" height="1" border="0"/></td>
			</tr>
		    <tr>
			    <td align="center"><font color="grey">Document generated by Confluence on May 31, 2004 05:05</font></td>
		    </tr>
	    </table>
    </body>
</html>